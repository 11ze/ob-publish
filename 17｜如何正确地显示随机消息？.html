<!DOCTYPE html>
<html><head><title>17｜如何正确地显示随机消息？</title><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="17｜如何正确地显示随机消息？"/><meta property="og:description" content="内存临时表 § explain 结果中 extra 包含 Using temporary，表示需要使用临时表 Using filesort 表示需要执行排序操作 比如执行 order by rand() 的时候就需要用到上面两个 随机排序完整执行流程图 pos 是数据的位置信息 对于内存表，回表过程只是简单地根据数据行的位置直接访问内存得到数据，MySQL 优化器没有多访问磁盘的顾虑，会直接选择 rowid 排序（排序的行越小越好） 学习技巧：先通过原理分析算出扫描行数，然后再通过查看慢查询日志，来验证自己的结论 rowid 的含义：每个引擎用来唯一标识数据行的信息 对于有主键的 InnoDB 表，rowid 是主键 ID； 对于没有主键的 InnoDB 表，rowid 是由系统生成的； MEMORY 引擎不是索引组织表。在这个例子里面，可以认为它就是一个数组。因此，这个 rowid 其实就是数组的下标。 磁盘临时表 § tmp_table_size 配置限制内存表的大小，默认值 16M 如果临时表过大，就会转成磁盘临时表 当使用磁盘临时表的时候，对应的就是一个没有显式索引的 InnoDB 表的排序过程。 对于使用磁盘临时表的 order by rand()，MySQL 5."/><meta property="og:image" content="https://wangze.tech/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="./static/icon.png"/><meta name="description" content="内存临时表 § explain 结果中 extra 包含 Using temporary，表示需要使用临时表 Using filesort 表示需要执行排序操作 比如执行 order by rand() 的时候就需要用到上面两个 随机排序完整执行流程图 pos 是数据的位置信息 对于内存表，回表过程只是简单地根据数据行的位置直接访问内存得到数据，MySQL 优化器没有多访问磁盘的顾虑，会直接选择 rowid 排序（排序的行越小越好） 学习技巧：先通过原理分析算出扫描行数，然后再通过查看慢查询日志，来验证自己的结论 rowid 的含义：每个引擎用来唯一标识数据行的信息 对于有主键的 InnoDB 表，rowid 是主键 ID； 对于没有主键的 InnoDB 表，rowid 是由系统生成的； MEMORY 引擎不是索引组织表。在这个例子里面，可以认为它就是一个数组。因此，这个 rowid 其实就是数组的下标。 磁盘临时表 § tmp_table_size 配置限制内存表的大小，默认值 16M 如果临时表过大，就会转成磁盘临时表 当使用磁盘临时表的时候，对应的就是一个没有显式索引的 InnoDB 表的排序过程。 对于使用磁盘临时表的 order by rand()，MySQL 5."/><meta name="generator" content="Quartz"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link href="./index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap" rel="stylesheet" type="text/css" spa-preserve/><script src="./prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch(`./static/contentIndex.json`).then(data => data.json())</script></head><body data-slug="17｜如何正确地显示随机消息？"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h1 class="page-title"><a href=".">🫧 11ze</a></h1><div class="spacer mobile-only"></div><div class="search"><div id="search-icon"><p>Search</p><div></div><svg tabIndex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search</title><desc id="desc">Search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></div><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="results-container"></div></div></div></div><div class="darkmode"><input class="toggle" id="darkmode-toggle" type="checkbox" tabIndex="-1"/><label id="toggle-label-light" for="darkmode-toggle" tabIndex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xmlSpace="preserve"><title>Light mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg></label><label id="toggle-label-dark" for="darkmode-toggle" tabIndex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'" xmlSpace="preserve"><title>Dark mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></label></div><div class="toc desktop-only"><button type="button" id="toc"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content"><ul class="overflow"><li class="depth-0"><a href="#内存临时表" data-for="内存临时表">内存临时表</a></li><li class="depth-0"><a href="#磁盘临时表" data-for="磁盘临时表">磁盘临时表</a></li><li class="depth-0"><a href="#思考题" data-for="思考题">思考题</a></li><li class="depth-0"><a href="#评论区" data-for="评论区">评论区</a></li></ul></div></div></div><div class="center"><div class="page-header"><div class="popover-hint"><h1 class="article-title">17｜如何正确地显示随机消息？</h1><p class="content-meta">Sep 13, 2023, 6 min read</p><ul class="tags"><li><a href="./tags/mysql" class="internal tag-link">#mysql</a></li></ul></div></div><article class="popover-hint"><h2 id="内存临时表">内存临时表<a aria-hidden="true" tabindex="-1" href="#内存临时表" class="internal"> §</a></h2>
<ul>
<li>
<p>explain 结果中 extra 包含 Using temporary，表示需要使用临时表</p>
</li>
<li>
<p>Using filesort 表示需要执行排序操作</p>
</li>
<li>
<p>比如执行 order by rand() 的时候就需要用到上面两个</p>
<ul>
<li>
<p>随机排序完整执行流程图</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/11ze/static/images/mysql45-17-1.png" alt="image.png"/></li>
</ul>
</li>
<li>
<p>pos 是数据的位置信息</p>
</li>
</ul>
</li>
<li>
<p>对于内存表，回表过程只是简单地根据数据行的位置直接访问内存得到数据，MySQL 优化器没有多访问磁盘的顾虑，会直接选择 rowid 排序（排序的行越小越好）</p>
</li>
<li>
<p>学习技巧：先通过原理分析算出扫描行数，然后再通过查看慢查询日志，来验证自己的结论</p>
</li>
<li>
<p>rowid 的含义：每个引擎用来唯一标识数据行的信息</p>
<ul>
<li>对于有主键的 InnoDB 表，rowid 是主键 ID；</li>
<li>对于没有主键的 InnoDB 表，rowid 是由系统生成的；</li>
<li>MEMORY 引擎不是索引组织表。在这个例子里面，可以认为它就是一个数组。因此，这个 rowid 其实就是数组的下标。</li>
</ul>
</li>
</ul>
<h2 id="磁盘临时表">磁盘临时表<a aria-hidden="true" tabindex="-1" href="#磁盘临时表" class="internal"> §</a></h2>
<ul>
<li>
<p>tmp_table_size 配置限制内存表的大小，默认值 16M</p>
</li>
<li>
<p>如果临时表过大，就会转成磁盘临时表</p>
</li>
<li>
<p>当使用磁盘临时表的时候，对应的就是一个没有显式索引的 InnoDB 表的排序过程。</p>
</li>
<li>
<p>对于使用磁盘临时表的 order by rand()，MySQL 5.6 版本引入了一个新的排序算法：优先队列排序算法</p>
<div data-rehype-pretty-code-fragment><pre style="background-color:var(--shiki-color-background);" tabindex="0" data-language="sql" data-theme="default"><code data-language="sql" data-theme="default"><span data-line> </span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> tmp_table_size</span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-token-constant);">1024</span><span style="color:var(--shiki-color-text);">;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> sort_buffer_size</span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-token-constant);">32768</span><span style="color:var(--shiki-color-text);">;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> max_length_for_sort_data</span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-token-constant);">16</span><span style="color:var(--shiki-color-text);">;</span></span>
<span data-line> </span>
<span data-line><span style="color:var(--shiki-token-comment);">/*打开 optimizer_trace，只对本线程有效*/</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">SET</span><span style="color:var(--shiki-color-text);"> optimizer_trace</span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-token-string-expression);">'enabled=on'</span><span style="color:var(--shiki-color-text);">;</span></span>
<span data-line> </span>
<span data-line><span style="color:var(--shiki-token-comment);">/*执行语句*/</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> word </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> words </span><span style="color:var(--shiki-token-keyword);">order by</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">rand</span><span style="color:var(--shiki-color-text);">() </span><span style="color:var(--shiki-token-keyword);">limit</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-constant);">3</span><span style="color:var(--shiki-color-text);">;</span></span>
<span data-line> </span>
<span data-line><span style="color:var(--shiki-token-comment);">/*查看 OPTIMIZER_TRACE 输出*/</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">SELECT</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">FROM</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-string-expression);">`information_schema`</span><span style="color:var(--shiki-color-text);">.</span><span style="color:var(--shiki-token-string-expression);">`OPTIMIZER_TRACE`</span><span style="color:var(--shiki-color-text);">\G</span></span>
<span data-line> </span></code></pre></div>
<ul>
<li>
<p><img src="https://cdn.jsdelivr.net/gh/11ze/static/images/mysql45-17-2.png" alt="image.png"/></p>
</li>
<li>
<p>结果中，chosen 表示使用了优先队列排序算法</p>
<ul>
<li>因为没用到临时文件，所以 number_of_tmp_files 是 0</li>
</ul>
</li>
<li>
<ol>
<li>
<p>对于这 10000 个准备排序的 (R,rowid)，先取前三行，构造成一个堆；</p>
</li>
</ol>
<ul>
<li>如果构成的堆大小超过 sort_buffer_size 的大小，只能使用归并排序算法</li>
</ul>
</li>
<li>
<ol start="2">
<li>取下一个行 (R’,rowid’)，跟当前堆里面最大的 R 比较，如果 R’小于 R，把这个 (R,rowid) 从堆中去掉，换成 (R’,rowid’)；</li>
</ol>
</li>
<li>
<ol start="3">
<li>重复第 2 步，直到第 10000 个 (R’,rowid’) 完成比较。</li>
</ol>
</li>
</ul>
</li>
<li>
<p>不用 order by rand() 的随机排序方法（推荐）</p>
<ul>
<li>
<p>随机算法 1</p>
<div data-rehype-pretty-code-fragment><pre style="background-color:var(--shiki-color-background);" tabindex="0" data-language="sql" data-theme="default"><code data-language="sql" data-theme="default"><span data-line><span style="color:var(--shiki-color-text);">mysql</span><span style="color:var(--shiki-token-keyword);">></span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">max</span><span style="color:var(--shiki-color-text);">(id),</span><span style="color:var(--shiki-token-function);">min</span><span style="color:var(--shiki-color-text);">(id) </span><span style="color:var(--shiki-token-keyword);">into</span><span style="color:var(--shiki-color-text);"> @M,@N </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t ;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> @X</span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">floor</span><span style="color:var(--shiki-color-text);">((@M</span><span style="color:var(--shiki-token-keyword);">-</span><span style="color:var(--shiki-color-text);">@N</span><span style="color:var(--shiki-token-keyword);">+</span><span style="color:var(--shiki-token-constant);">1</span><span style="color:var(--shiki-color-text);">)</span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-token-function);">rand</span><span style="color:var(--shiki-color-text);">() </span><span style="color:var(--shiki-token-keyword);">+</span><span style="color:var(--shiki-color-text);"> @N);</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t </span><span style="color:var(--shiki-token-keyword);">where</span><span style="color:var(--shiki-color-text);"> id </span><span style="color:var(--shiki-token-keyword);">>=</span><span style="color:var(--shiki-color-text);"> @X </span><span style="color:var(--shiki-token-keyword);">limit</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-constant);">1</span><span style="color:var(--shiki-color-text);">;</span></span></code></pre></div>
<ul>
<li>
<ol>
<li>
<p>取得表的主键的最大和最小值；</p>
</li>
</ol>
<ul>
<li>此操作不需要扫描索引</li>
</ul>
</li>
<li>
<ol start="2">
<li>用随机函数生成一个最大到最小值之间的数 X = (M-N)*rand() + N；</li>
</ol>
</li>
<li>
<ol start="3">
<li>
<p>取不小于 X 的第一个 ID 的行。</p>
</li>
</ol>
<ul>
<li>可以用索引快速定位</li>
</ul>
</li>
<li>
<p>效率高，适用于 ID 严格递增的情况</p>
<ul>
<li>即没有空洞</li>
<li>可以人为对数据进行处理，使数据符合条件</li>
</ul>
</li>
</ul>
</li>
<li>
<p>随机算法 2</p>
<div data-rehype-pretty-code-fragment><pre style="background-color:var(--shiki-color-background);" tabindex="0" data-language="sql" data-theme="default"><code data-language="sql" data-theme="default"><span data-line><span style="color:var(--shiki-color-text);">mysql</span><span style="color:var(--shiki-token-keyword);">></span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">count</span><span style="color:var(--shiki-color-text);">(</span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);">) </span><span style="color:var(--shiki-token-keyword);">into</span><span style="color:var(--shiki-color-text);"> @C </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> @Y </span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">floor</span><span style="color:var(--shiki-color-text);">(@C </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">rand</span><span style="color:var(--shiki-color-text);">());</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> @sql </span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">concat</span><span style="color:var(--shiki-color-text);">(</span><span style="color:var(--shiki-token-string-expression);">&quot;select * from t limit &quot;</span><span style="color:var(--shiki-color-text);">, @Y, </span><span style="color:var(--shiki-token-string-expression);">&quot;,1&quot;</span><span style="color:var(--shiki-color-text);">);</span></span>
<span data-line><span style="color:var(--shiki-color-text);">prepare stmt </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> @sql;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">execute</span><span style="color:var(--shiki-color-text);"> stmt;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">DEALLOCATE</span><span style="color:var(--shiki-color-text);"> prepare stmt;</span></span></code></pre></div>
<ul>
<li>
<ol>
<li>取得整个表的行数，记为 C；</li>
</ol>
</li>
<li>
<ol start="2">
<li>取得 Y = floor(C * rand())。 floor 函数在这里的作用，就是取整数部分。</li>
</ol>
</li>
<li>
<ol start="3">
<li>再用 limit Y,1 取得一行。</li>
</ol>
</li>
<li>比算法 1 代价高，但还是比 order by rand() 小很多</li>
</ul>
</li>
<li>
<p>随机算法 3</p>
<div data-rehype-pretty-code-fragment><pre style="background-color:var(--shiki-color-background);" tabindex="0" data-language="sql" data-theme="default"><code data-language="sql" data-theme="default"><span data-line><span style="color:var(--shiki-color-text);">mysql</span><span style="color:var(--shiki-token-keyword);">></span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">count</span><span style="color:var(--shiki-color-text);">(</span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);">) </span><span style="color:var(--shiki-token-keyword);">into</span><span style="color:var(--shiki-color-text);"> @C </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t;</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> @Y1 </span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">floor</span><span style="color:var(--shiki-color-text);">(@C </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">rand</span><span style="color:var(--shiki-color-text);">());</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> @Y2 </span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">floor</span><span style="color:var(--shiki-color-text);">(@C </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">rand</span><span style="color:var(--shiki-color-text);">());</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">set</span><span style="color:var(--shiki-color-text);"> @Y3 </span><span style="color:var(--shiki-token-keyword);">=</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">floor</span><span style="color:var(--shiki-color-text);">(@C </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-function);">rand</span><span style="color:var(--shiki-color-text);">());</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t </span><span style="color:var(--shiki-token-keyword);">limit</span><span style="color:var(--shiki-color-text);"> @Y1，</span><span style="color:var(--shiki-token-constant);">1</span><span style="color:var(--shiki-color-text);">； </span><span style="color:var(--shiki-token-keyword);">//</span><span style="color:var(--shiki-color-text);">在应用代码里面取Y1、Y2、Y3值，拼出SQL后执行</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t </span><span style="color:var(--shiki-token-keyword);">limit</span><span style="color:var(--shiki-color-text);"> @Y2，</span><span style="color:var(--shiki-token-constant);">1</span><span style="color:var(--shiki-color-text);">；</span></span>
<span data-line><span style="color:var(--shiki-token-keyword);">select</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">*</span><span style="color:var(--shiki-color-text);"> </span><span style="color:var(--shiki-token-keyword);">from</span><span style="color:var(--shiki-color-text);"> t </span><span style="color:var(--shiki-token-keyword);">limit</span><span style="color:var(--shiki-color-text);"> @Y3，</span><span style="color:var(--shiki-token-constant);">1</span><span style="color:var(--shiki-color-text);">；</span></span></code></pre></div>
</li>
</ul>
</li>
</ul>
<h2 id="思考题">思考题<a aria-hidden="true" tabindex="-1" href="#思考题" class="internal"> §</a></h2>
<ul>
<li>
<p>优化算法 3</p>
<ul>
<li>
<p>将三个 Y 排序，从小的开始查，下一个 Y 从中断的地方接着查</p>
</li>
<li>
<p>也可以先取回 id 值，在应用中确定三个 id 值以后，执行三次 where id=X 的语句</p>
</li>
<li>
<p>下一章给的答案</p>
<ul>
<li>取 Y1、Y2 和 Y3 里面最大的一个数，记为 M，最小的一个数记为 N，然后执行下面这条 SQL 语句：<code>mysql> select * from t limit N, M-N+1;</code> 取出来后再拿到三个 Y；再加上取整个表总行数的 C 行，这个方案的扫描行数总共只需要 C+M+1 行。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="评论区">评论区<a aria-hidden="true" tabindex="-1" href="#评论区" class="internal"> §</a></h2>
<ul>
<li>排序操作是在 server 层做的</li>
<li>排序过程本身不增加扫描行数，扫描原表和内存表会增加</li>
<li>只要 sort buffer 足够，就采用优先队列排序，而不用管到底是全字段排序还是 rowid 排序，前提是有 limit 子句</li>
</ul></article></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1}"></div><svg version="1.1" id="global-graph-icon" xmlns="http://www.w3.org/2000/svg" xmlnsXlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xmlSpace="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
	s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
	c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
	C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
	c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
	v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
	s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
	C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
	S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
	s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
	s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1}"></div></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="./MySQL-实战-45-讲" class="internal">MySQL 实战 45 讲</a></li></ul></div></div></div><footer><hr/><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.0.10</a>, © 2023</p><ul><li><a href="https://github.com/11ze/ob-publish">GitHub</a></li><li><a href="https://twitter.com/11ze4">Twitter</a></li></ul></footer></div></body><script type="application/javascript">// quartz/components/scripts/quartz/components/scripts/callout.inline.ts
function toggleCallout() {
  const outerBlock = this.parentElement;
  outerBlock.classList.toggle(`is-collapsed`);
  const collapsed = outerBlock.classList.contains(`is-collapsed`);
  const height = collapsed ? this.scrollHeight : outerBlock.scrollHeight;
  outerBlock.style.maxHeight = height + `px`;
  let current = outerBlock;
  let parent = outerBlock.parentElement;
  while (parent) {
    if (!parent.classList.contains(`callout`)) {
      return;
    }
    const collapsed2 = parent.classList.contains(`is-collapsed`);
    const height2 = collapsed2 ? parent.scrollHeight : parent.scrollHeight + current.scrollHeight;
    parent.style.maxHeight = height2 + `px`;
    current = parent;
    parent = parent.parentElement;
  }
}
function setupCallout() {
  const collapsible = document.getElementsByClassName(
    `callout is-collapsible`
  );
  for (const div of collapsible) {
    const title = div.firstElementChild;
    if (title) {
      title.removeEventListener(`click`, toggleCallout);
      title.addEventListener(`click`, toggleCallout);
      const collapsed = div.classList.contains(`is-collapsed`);
      const height = collapsed ? title.scrollHeight : div.scrollHeight;
      div.style.maxHeight = height + `px`;
    }
  }
}
document.addEventListener(`nav`, setupCallout);
window.addEventListener(`resize`, setupCallout);
</script><script type="module">
          import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
          const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
          mermaid.initialize({
            startOnLoad: false,
            securityLevel: 'loose',
            theme: darkMode ? 'dark' : 'default'
          });
          document.addEventListener('nav', async () => {
            await mermaid.run({
              querySelector: '.mermaid'
            })
          });
          </script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script src="https://www.googletagmanager.com/gtag/js?id=G-SZZLS6FREP" type="application/javascript"></script><script src="./postscript.js" type="module"></script></html>