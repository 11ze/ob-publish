---

title: 08｜哨兵集群：哨兵挂了，主从库还能切换吗？
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-18T21:29:15+08:00

---

- 本质上哨兵就是一个运行在特定模式下的 Redis 实例。
- 基于 pub/sub 机制的哨兵集群组成过程（发布/订阅机制）

  - 只有订阅了同一个频道的应用才能通过发布的消息进行信息交换
  - 哨兵通过 __sentinel__:hello 频道互相发现、通信

- 给主库发送 INFO 命令拿到从库列表，哨兵根据列表上的连接信息和从库建立连接并监控
- 基于哨兵自身的 pub/sub 功能，实现客户端和哨兵之间的事件通知

  - 重要的频道汇总图
    - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/redis-08-1.png)

  - 如：客户端执行 SUBSCRIBE * 订阅所有事件

- 由哪一个哨兵执行主从切换？

  - 和主库客观下线的判断过程类似，投票仲裁
  - 1. 标记主库“主观下线”
  - 2. 向其他哨兵实例要赞成票
  - 3. 获得仲裁所需的赞成票后，就可以标记主库为“客观下线”。
  - 4. 成功标记主库为客观下线的哨兵实例向其他哨兵发送命令，表明希望执行主从切换
  - 5. 投票（Y/N），确定 Leader

    - 1. 拿到半数以上赞成票
    - 2. 拿到的票数大于等于哨兵配置文件中的 quorum 值
    - 每个哨兵只能投一个赞成票，可以给自己投，第一次必投 Y
    - 所有哨兵同时判断主库主观下线，然后同时得到客观下线的结论时，每个哨兵各自一票（概率极低）

- 要保证所有哨兵实例的配置是一致的，尤其是主观下线的判断值 down-after-milliseconds
- 思考题

  - 配置了包含 5 个哨兵实例的集群，quorum 值设为 2。在运行过程中，如果有 3 个哨兵实例都发生故障了，此时，Redis 主库如果有故障，还能正确地判断主库“客观下线”吗？

    - 能，两个哨兵都给出主观下线的结果，达到了 quorum 的值

  - 如果可以的话，还能进行主从库自动切换吗？

    - 不能主从切换，选举 Leader 拿不到超过半数的选票（5/2 + 1 = 3）

  - 哨兵实例是不是越多越好呢？

    - 不是。通信次数增多，故障风险变大，选举时间变长

  - 调大 down-after-milliseconds 值，对减少误判有没有好处？

    - 有好处，降低误判的概率，但主从切换时间变长，对业务影响时间变久
