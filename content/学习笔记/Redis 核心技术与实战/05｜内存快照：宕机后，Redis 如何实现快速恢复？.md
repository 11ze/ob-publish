---

title: 05｜内存快照：宕机后，Redis 如何实现快速恢复？
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-18T21:16:43+08:00

---

- 和 AOF 相比，RDB 记录某一时刻的数据，恢复时直接把 RDB 文件读入内存

  - 类比拍照
  - 全量快照

- 生成 RDB 文件的方案

  - save：在主线程中执行，会导致阻塞
  - bgsave：创建一个子进程，复制主线程的页表，专门写入 RDB 文件，避免阻塞。默认配置

    - 共享主线程的所有内存数据

- 快照时数据能修改吗？

  - 读操作：bgsave 子进程和主线程互不影响
  - 能
  - 写操作：生成被修改的一块数据的副本，bgsave 子进程继续写 RDB 文件，主线程在副本上进行修改
  - 写时复制：主线程在有写操作时，才会把这个新写或修改后的数据写入到一个新的物理地址中，并修改自己的页表映射
    - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/redis-05-1.png)


- 可以每秒做一次快照吗？

  - 磁盘压力
  - fork bgsave 子进程的过程会阻塞主线程

- 混合使用 AOF 和内存快照

  - AOF 只保留从最后一次快照开始的改动

- 数据不能丢失时，内存快照和 AOF 的混合使用是一个很好的选择
- 如果允许分钟级别的数据丢失，可以只使用 RDB
- 如果只用 AOF，优先使用 everysec 的配置选项，因为它在可靠性和性能之间取了一个平衡
- 持久化有关的风险

  - 服务器内存不足

    - 写时复制为写、修改操作涉及的数据分配相同大小的内存副本

  - 子进程也会占用 CPU 资源
  - 需要开启定时 RDB 和 AOF 重写时进程一定不要绑定 CPU：子进程会与父进程争夺同一个 CPU 资源（具体搜索关键字找到后面有关绑定 CPU 的章节）
