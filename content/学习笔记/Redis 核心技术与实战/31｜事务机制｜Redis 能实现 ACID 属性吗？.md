---

title: 31｜事务机制｜Redis 能实现 ACID 属性吗？
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-24T21:09:04+08:00

---

- 事务命令

  - MULTI

    - 开启一个事务

  - EXEC

    - 提交事务，从命令队列中去除提交的操作命令，进行实际执行

  - DISCARD

    - 放弃一个事务，清空命令队列

      - 只是清空，起不到回滚的作用

  - WATCH

    - 检测一个或多个键的值在事务执行期间是否发生变化，如果发生变化，那么当前事务放弃执行
      - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/redis-31-1.png)

- Redis 的事务机制

  - 可以保证一致性和隔离性，无法保证持久性（非必要）
  - 原子性

    - 命令语法有误时，得不到保证

      - 不存在的命令一开始就会被记录错误
      - 无法得到保证的原因：命令和操作的数据类型不匹配，但 Redis 实例没检查出错误并开始执行
      - 预防建议：严格按照 Redis 的命令规范进行程序开发，并且通过 code review 确保命令的正确性

    - 实例发生故障，且 Redis 使用了 RDB 机制

      - RDB 不会在事务执行时执行，也就不会记录下事务执行了一部分的结果
      - 存在一种情况无法保证原子性：如果事务执行完成，还没执行 RDB 快照，此时发生故障，会丢失事务修改的数据

    - 其他情况，事务都可以原子性执行

      - 前提：执行事务的 EXEC 命令时，Redis 实例发生了故障，导致事务执行失败
      - 开启 AOF 日志

        - 1. 只会有部分的事务操作被记录到 AOF 日志中
        - 2. 使用 redis-check-aof 工具检查 AOF 日志文件
        - 3. 工具会把未完成的事务操作从 AOF 日志中去除
        - 4. 这时再使用 AOF 恢复实例，失败的事务操作不会再被执行

- 事务使用建议

  - 1. 配合 Pipeline 使用

    - 隔离性由服务端保证，此时不需要使用 WATCH

  - 2. WATCH 的使用场景

    - WATCH key，读取 key，修改 key，写回
