---

title: 07｜哨兵机制：主库挂了，如何不间断服务？
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-18T21:27:01+08:00

---

- 哨兵机制的基本流程

  - 1. 监控：判断主从库下线

  - 主观下线

    - 哨兵进程会使用 PING 命令检测它自己和主、从库的网络连接情况，用来判断实例的状态。
    - 如果哨兵发现主库或从库对 PING 命令的响应超时了，哨兵就会先把它标记为“主观下线”。
    - 从库会被直接标记为“主观下线”。

  - 客观下线

  - 大多数的哨兵判断主库主观下线，主库才会标记为客观下线

  - 减少误判

    - 哨兵集群：哨兵机制通常采用多实例组成的集群模式部署

  - 2. 选主：选出新主库（筛选 + 打分）

    - 1. 按照一定的筛选条件去掉不符合条件的从库

      - 在线状态
      - 网络状态

        - 配置项（ms）down-after-milliseconds * 10
        - 如果在 down-after-milliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了
        - 如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好
        - 此参数可以调节哨兵的敏感程度

    - 2. 按照一定的规则给剩下的从库逐个打分

      - 从库优先级

        - 通过 slave-priority 配置项设置

      - 从库复制进度

        - 和旧主库同步程度最接近的从库得分高

          - salve_repl_offset 最大

      - 从库 ID 号

        - 在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库。

    - 3. 得分最高的作为新主库
    - 新主库的选择过程
      - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/redis-07-1.png)

  - 3. 通知

    - 1. 让从库执行 replicaof 与新主库同步

      - 4.0 之前全量同步，4.0 之后增量同步，了解 psync2

    - 2. 通知客户端与新主库连接

- 切换过程中，客户端能否正常进行请求操作？

- 客户端使用了读写分离时不会受到影响
- 写请求失败持续的时间 = 哨兵切换主从的时间 + 客户端感知到新主库的时间

- 如果想要应用程序不感知服务的中断，还需要哨兵或客户端做些什么？

  - 客户端把写失败的请求先缓存起来或写入消息队列中间件中，等哨兵切换完主从后，再把这些写请求发给新主库，只适合对写入请求返回值不敏感的业务，需要业务层做适配
  - 哨兵主动通知客户端

    - 1. 哨兵将新主库地址写入自己实例的 pub/sub（switch-master 事件）中
    - 2. 客户端订阅 pub/sub，有数据时，客户端能感知到主库变更，同时可以拿到最新的主库地址

  - 客户端通过 sentinel get-master-addr-by-name 命令从哨兵集群中获取最新的地址
  - 一般 Redis 的 SDK 都提供了通过哨兵拿到实例地址，再访问实例的方式，直接使用即可
