---

title: 32｜Redis 主从同步与故障切换，有哪些坑？
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-24T21:10:58+08:00

---

- 1. 主从数据不一致

  - 因为主从数据是异步复制

    - a）使用外部监控程序对比主从库复制进度，不让客户端从落后的从库中读取数据

      - 开发一个工具：

      - 基于 INFO replication 命令查看主库接收写命令的进度信息（master_repl_offset）和从库复制写命令的进度信息（slave_repl_offset）
      - 比较两者大小，大于我们预设的阈值则不让客户端和此从库连接

    - b）保证主从间的网络链接状况良好

- 2. 读到过期数据

  - Redis 同时使用两种策略删除过期的数据

    - 惰性删除

      - 当一个数据过期时间到了之后，不会立即删除数据，等到再有请求读写这个数据时，检查发现过期再删除
      - 好处是对于用不到的数据，不浪费时间进行检查和删除
      - 会导致大量已过期数据留存在内存中

        - 而且，从库本身不会执行删除操作，只能同步主库的删除操作，所以主库可能已经自动删除的数据，在从库还有留存

    - 定期删除

      - Redis 每隔一段时间（默认 100ms）随机选出一定数量的数据，删除其中过期的数据

  - Redis 3.2 之前，数据过期但未删除时，会被读取，之后的版本会检查过期，返回空值
  - EXPIRE 和 PEXPIRE：给数据设置的是从命令执行时开始计算的存活时间

    - 加上主从节点执行命令的时间不一致，导致数据的过期时间不一致

  - EXPIREAT 和 PEXPIREAT：直接把数据的过期时间设置为具体的一个时间点

    - 业务中使用这个
    - 一定要保证主从节点的时钟一致

- 3. 不合理配置项导致服务挂掉

  - 1. protected-mode

    - 设置哨兵实例能否被其他服务器访问
    - 当设置为 yes，而其余哨兵实例部署在其它服务器，这些哨兵实例间就无法通信。当主库故障时，哨兵无法判断主库下线，也无法进行主从切换，最终 Redis 服务不可用
    - 应该设置为 no，并设置白名单

  - 2. cluster-node-timeout 配置不合理

    - 设置了 Redis Cluster 中实例响应心跳消息的超时时间
    - 调大些，例如为 10 到 20 秒

- 4. 主从库的 mexmemory 不同

  - 一定要相同

- 5. 其他建议

  - slave-serve-stale-data 配置项设置从库能否处理数据读写命令，no 时，从库只能服务 INFO、SLAVEOF 命令，可以避免在从库中读到不一致的数据
  - 不要让从库可以处理写请求

    - slave-read-only 设置为 yes，从库不能处理写请求，但还能读
