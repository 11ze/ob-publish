---

title: 38｜通信开销：限制 Redis Cluster 规模的关键因素
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-24T21:26:49+08:00

---

- Redis Cluster 实例间以 Gossip 协议进行通信的机制

  - Gossip 协议的工作原理

    - 两个实例间进行 PING、PONG 消息传递的情况![](https://cdn.nlark.com/yuque/0/2022/png/958759/1667535602136-4f62ef06-a7a1-414c-a5c3-bacb481945d2.png)
    - 每个实例默认每秒从集群中随机挑选一些实例，把 PING 消息发送给挑选出来的实例，用来检测这些实例是否在线，并交换彼此的状态信息
    - PING 消息中封装了发送消息的实例自身的状态信息、部分其它实例的状态信息，以及 Slot 映射表
    - 一个实例在接收到 PING 消息后，会给发送 PING 消息的实例，发送一个 PONG 消息。PONG 消息包含的内容和 PING 消息一样

  - Gossip 消息大小

    - PING 和 PONG 消息的消息体都大约 12KB
    - PING 消息中带有一个长度为 16384 bit 的 Bitmap

      - 每一位对应一个 Slot，如果某一位为 1，表示这个 Slot 属于当前实例

  - 实例间通信频率

    - 1. Gossip 协议的工作原理第二点
    - 2. 实例每 100ms 扫描本地的实例列表，如果发现有实例最近一次接收 PONG 消息的时间已经大于配置项 cluster-node-timeout 的一半，就会立刻给该实例发送 PING 消息，更新这个实例上的集群状态信息
    - 每秒会发送的 PING 消息数量 = 1 + 10 * 实例数

      - 实例数 = 最近一次接收 PONG 消息的时间超出 cluster-node-timeout/2

  - 降低实例间的通信开销

    - 不能减小实例传输的消息大小
    - 只能修改 cluster-node-timeout 配置项

      - 默认 15 秒，调大到 20 或 25 秒
      - 验证调整后的值是否能减少心跳消息占用的集群网络带宽

        - 调整前后使用 tcpdump 命令抓取实例发送心跳信息网络包的情况
        - 例如，执行：tcpdump host 192.168.10.3 port 16379 -i 网卡名 -w /tmp/r1.cap
        - 通过分析网络包的数量和大小，就可以判断调整 cluster-node-timeout 值前后，心跳消息占用的带宽情况

- 建议把 Redis Cluster 的规模控制在 400~500 个实例

  - 假设单个实例每秒能支撑 8 万请求操作（8 万 QPS），每个主实例配置 1 个从实例，400~ 500 个实例可支持 1600 万~2000 万 QPS（200/250 个主实例 *8 万 QPS=1600/2000 万 QPS），这个吞吐量性能可以满足不少业务应用的需求

- 建议针对不同的业务线、业务模块，单独部署不同的分片集群，方便运维和管理，出问题也只会影响某一个业务模块
