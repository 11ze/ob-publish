---

title: 17｜为什么 CPU 结构也会影响 Redis 的性能？
tags:
- Redis
- mindmap-plugin: basic
createdAt: 2023-05-22T21:23:13+08:00

---

- NUMA 架构（Non-Uniform Memory Access 非统一内存访问架构）

  - 图

    - 第一步
      - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/redis-17-1.png)

    - 第二步
      - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/redis-17-2.png)

  - 文字描述

    - 多个 CPU 处理器（多 CPU Socket）

      - 每个都有自己的

          - 多个物理核（包括 L1、L2 缓存）

            - 每个物理核私有的 L1、L2 大小受限于处理器的制造基数，KB 级别大小

              - 缓存应用程序访问最频繁的指令和数据

            - 现在主流的 CPU 处理器中，每个物理核通常都会运行两个超线程，也叫作逻辑核。同一个物理核的逻辑核会共享使用 L1、L2 缓存

        - L3 缓存

          - 多个物理核共用
          - 几 MB 到几十 MB 大小
          - 在 L1、L2 缓存中没有数据缓存时被访问，尽可能避免访问内存

        - 连接的内存

      - 不同处理器间通过总线连接

- CPU 架构对应用程序运行的影响

  - L1、L2 缓存中的指令和数据的访问速度很快，充分利用 L1、L2 缓存，可以有效缩短应用程序的执行时间
  - 在 NUMA 架构下，如果应用程序从一个 Socket 上调度到另一个 Socket 上，就可能会出现远端内存访问的情况，这会直接增加应用程序的执行时间

- ECS 主机提供的 vCPU 

  - 虚拟核，一般对应一个物理核心上的一个超线程，这是因为底层服务器一般会开启超线程
  - 通常，一个物理核心会对应 2 个超线程，每个超线程对应一个 vCPU
  - 多个 vCPU 一般在同一个 NUMA 节点上
  - 如果希望减少 CPU 超线程对性能的影响，可以通过阿里云 SDK 的选项关闭超线程

- CPU 多核对 Redis 性能的影响

  - 99% 尾延迟：99% 的请求延迟小于的值
  - context switch：一个线程先在一个 CPU 核上运行，之后又切换到另一个 CPU 核上运行，这时就会发生 context switch

    - 此时 Redis 主线程的运行时信息需要被加载到另一个 CPU 核上

- CPU 的 NUMA 架构对 Redis 性能的影响

  - 把操作系统的网络中断处理程序和 CPU 核绑定

    - 网络中断处理程序

      - 操作系统内核中用来处理网卡中断事件、把数据从内核的缓冲区拷贝到应用程序缓冲区的程序。
      - 当网卡接收到数据后，会触发网卡中断，用来通知操作系统内核进行数据处理。

    - 避免网络中断处理程序在不同核上来回调度执行，能有效提升 Redis 的网络处理性能

  - 为了避免 Redis 跨 CPU Socket 访问网络数据，最好把网络中断程序和 Redis 实例绑在同一个 CPU Socket 的不同核上
  - 在 CPU 的 NUMA 架构下，对 CPU 核的编号规则，并不是先把一个 CPU Socket 中的所有逻辑核编完，再对下一个 CPU Socket 中的逻辑核编码，而是先给每个 CPU Socket 中每个物理核的第一个逻辑核依次编号，再给每个 CPU Socket 中的物理核的第二个逻辑核依次编号

    - 执行 lscpu 命令 查看核的编号

- 绑核的风险和解决方案

  - 风险

    - 把 Redis 实例绑到一个 CPU 逻辑核上时，会导致子进程、后台线程和 Redis 主线程竞争 CPU 资源，一旦子进程或后台线程占用 CPU 时，主线程就会被阻塞，导致 Redis 请求延迟增加

  - 解决方案

    - 一个 Redis 实例对应绑一个物理核

      - 将实例绑到一个物理核上的所有逻辑核
      - Redis 的主线程、子进程和后台线程可以共享使用一个物理核上的两个逻辑核，缓解 CPU 资源竞争

    - 优化 Redis 源码

      - 避免切换核带来的性能影响
      - 让子进程、后台线程核主线程不在同一个核上运行，避免 CPU 资源竞争

    - Redis 6.0 之后支持 CPU 核绑定的配置操作

- 在一台有 2 个 CPU Socket（每个 Socket 8 个物理核）的服务器上，我们部署了有 8 个实例的 Redis 切片集群（ 8 个实例都为主节点，没有主备关系），采用哪种方案绑核最佳？

  - 后者
  - 1. 充分利用 2 个 L3 缓存
  - 2. 就近访问各自的内存
  - 3. 前者会增大用到 Swap 的概率，CPU Socket 的内存不够时可能不会去另一个节点申请内存

    - 操作系统可以配置内存回收策略和 Swap 使用倾向：本节点回收内存/其他节点申请内存/内存数据换到 Swap 的倾向程度
