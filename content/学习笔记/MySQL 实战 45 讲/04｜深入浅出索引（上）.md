---

title: 04｜深入浅出索引（上）
tags:
- MySQL
createdAt: 2023-05-17T10:09:25+08:00

---

- 每遇到一个新数据库，先关注它的数据模型，分析数据库的适用场景
- 数据库底层存储的核心基于的数据模型：哈希表、有序数组、二叉树、N 叉树等

## InnoDB 的索引模型

- 每一个索引在 InnoDB 里面对应一颗 `B+ 树`
- 主键索引也被称为聚簇索引（clustered index）
  - 叶子节点内容是整行数据
  - 主键查询只需要搜索主键这颗 B+ 树
  - 整张表的数据存在主键索引中，这就是“聚簇索引”的意思
- 非主键索引也被称为二级索引（secondary index）
  - 叶子节点内容是主键的值
    - 如果主键索引是多个列，二级索引里包含的主键也是多列
  - 回表：普通索引查询，先拿到主键，再到主键索引树搜索一次
- 叶子节点是 page（数据页），一个页里面可以存多个行
  - 页大小 16k，则行个数 = 16k/行大小
- 索引维护
  - 页分裂
    - 新增加一个数据页，挪动部分数据过去，空间利用率降低大概 50%
    - 不挪动数据的新增数据页操作不叫页分裂
  - 当相邻的两个数据页利用率很低的时候会做数据页合并
- 主键
  - 建议使用自增主键
    - 建议设置 `bigint unsigned`
  - 使用业务主键的场景（典型的 KV 场景）
    1. 只有一个索引
    2. 该索引必须是唯一索引
  - 没有主键的表，InnoDB 会默认创建一个 RowId 做主键
  - ⚠️ 加主键会重建表
- 索引只能定位到 `page`，`page` 内部是个有序数组，用二分法
  - 数据页中有页目录，页目录的 key 为 id ，value 为槽位
  - 二分搜索页目录定位到槽位中的行记录
  - 内存数据页和磁盘数据页是一一对应的，持久化的时候直接覆盖写进去
- 叶子节点中的数据连接方式
  - 叶子内是单向链表
  - 叶子间是双向链表

## 什么时候需要重建索引

- 索引可能因为删除操作、页分裂等原因，导致数据页有空洞
  - 即空间未释放
- 重建索引的过程会创建一个新的索引，把数据按顺序插入，页面的利用率最高，更省空间

## 思考题

- 重建普通 k 索引
  - alter table T drop index k;
  - alter table T add index(k);
- 重建主键索引
  - alter table T drop primary key;
  - alter table T add primary key(id);
- 对于上面这两个重建索引的做法，说出你的理解。
  - 重建索引 k 的做法合理，可以达到省空间的目的
  - 重建主键的过程不合理
- 为什么不合适？
  - 删除或创建主键都会将整个表重建，导致第一个语句白做
- 更好的方法
  - 使用 alter table T engine=InnoDB 代替
    - 触发 MySQL 重建该表，并进行碎片处理
    - 5.6 版本以后支持 online ddl，没有行锁，有 mdl 读锁
  - 在第 12 讲有分析 [[12｜为什么我的 MySQL 会“抖”一下？]]
