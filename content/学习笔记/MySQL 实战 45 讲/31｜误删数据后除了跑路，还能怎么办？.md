---

title: 31｜误删数据后除了跑路，还能怎么办？
tags:
- MySQL
createdAt: 2023-05-17T21:48:05+08:00

---

- 1. 使用 delete 语句误删数据行；
- 2. 使用 drop table 或者 truncate table 语句误删数据表；
- 3. 使用 drop database 语句误删数据库；
- 4. 使用 rm 命令误删整个 MySQL 实例。
- 误删行

  - 恢复数据比较安全的做法，是恢复出一个备份，或者找一个从库作为临时库，在这个临时库上执行这些操作，然后再将确认过的临时库的数据，恢复回主库。
  - 预防

    - 1. 把 sql_safe_updates 参数设置为 on。这样一来，如果我们忘记在 delete 或者 update 语句中写 where 条件，或者 where 条件里面没有包含索引字段的话，这条语句的执行就会报错。
    - 2. 代码上线前，必须经过 SQL 审计。

  - delete 全表很慢，应该优先考虑使用 truncate table 或者 drop table 命令

- 误删库 / 表

  - 即使配置了 binlog_format=row，记录的还是 statement 格式，binlog 只有一个 truncate/drop 语句，不足以恢复数据
  - 恢复方法：使用全量备份 + 增量日志的方式
  - 1. 加速数据恢复：使用 mysqlbinlog 命令时加上 -database 参数指定误删表所在的库
  - 2. 应用日志时跳过误操作的语句的 binlog

    - 1. 如果原实例没有使用 GTID 模式，只能在应用到包含错误语句的 binlog 文件时，先用 -stop-position 参数执行到误操作之前的日志，再用 -start-position 从误操作之后的日志继续执行
    - 2. 如果实例使用了 GTID 模式，假设误操作命令的 GTID 时 gtid1，执行 set gtid_next=gtid1; begin; commit; 把这个 GTID 加到临时实例的 GTID 集合，之后顺序执行 binlog 的时候会自动跳过误操作的语句

  - 上述使用 mysqlbinlog 方法恢复数据不够快

    - 1. mysqlbinlog 不能指定只解析一个表的日志
    - 2. 单线程

  - 加速方法之一：在用备份恢复出临时实例之后，把实例设置成线上备库的从库

    - 1. 在 start slave 之前，先通过执行change replication filter replicate_do_table = (tbl_name) 命令，就可以让临时库只同步误操作的表；
    - 2. 这样做也可以用上并行复制技术，来加速整个数据恢复过程。
    - 如果备库上没有日志的话，从备份中下载恢复
      - ![image.png](https://cdn.jsdelivr.net/gh/11ze/static/images/mysql45-31-1.png)


  - 建议把上述恢复功能做成自动化工具，并且经常拿出来演练

- 延迟复制备库

  - MySQL 5.6 引入
  - 延迟复制的备库是一种特殊的备库，通过 CHANGE MASTER TO MASTER_DELAY = N 命令，可以指定这个备库持续保持跟主库有 N 秒的延迟。
  - 备库上执行 stop slave，再通过之前介绍的方法，跳过误操作命令，就可以恢复出需要的数据。
  - 随时可以得到一个，只需要最多再追 n 秒，就可以恢复出数据的临时实例，也就缩短了整个数据恢复需要的时间。

- 预防误删库 / 表的方法

  - 第一条建议是，账号分离。这样做的目的是，避免写错命令。
  - 第二条建议是，制定操作规范。这样做的目的，是避免写错要删除的表名。

    - 1. 在删除表之前，必须先对表做改名操作，然后观察一段时间。
    - 2. 改表名时，要求给表名加固定的后缀（比如 _to_be_deleted），删除表的动作必须通过管理系统执行，并且只能删除固定后缀的表

- rm 删除数据

  - 重做即可

- 思考题

  - 误删数据事件

    - 登错环境

- 评论区

  - 不同的浏览器浏览文件可能会截断或乱码

    - 可以把脚本放到 git 上，然后把 git 地址和文件的 md5 发给要执行的人

  - 修改生产的数据，或者添加索引优化，都要先写好四个脚本：备份脚本、执行脚本、验证脚本、回滚脚本
  - 通过 chatrr +i 命令给所有重要的文件增加了 i 权限属性，这样哪怕 root 用户都无法直接删除文件。
- rename 很快
