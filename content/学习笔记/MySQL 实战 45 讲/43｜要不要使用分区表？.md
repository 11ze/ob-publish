---

title: 43｜要不要使用分区表？
tags:
- MySQL
createdAt: 2023-05-17T22:24:46+08:00

---

- 分区表：对于引擎层，n 个表对于 server 层，1 个表
- 分区策略

  - MyISAM 分区表
  - InnoDB 分区表
  - 通用分区策略：每次访问都由 server 层控制

    - MyISAM 分区表使用的分区策略
    - 性能较差
    - 5.7.17 开始标记为即将弃用8.0 开始不允许使用
    - 打开分区表时，如果分区过多，超过 open_files_limit 参数设置的值时会报错，默认 1024

  - 本地分区策略：引擎内部自己管理打开分区的行为

    - InnoDB 和 NDB 引擎支持了
    - 没有通用分区策略会报错的问题：innodb_open_files 参数控制打开多少个文件后自动关闭一些之前打开的文件

- 分区表的 server 层行为

  - 1. MySQL 在第一次打开分区表的时候，需要访问所有的分区；
  - 2. 在 server 层，认为这是同一张表，因此所有分区共用同一个 MDL 锁；
  - 3. 在引擎层，认为这是不同的表，因此 MDL 锁之后的执行过程，会根据分区表规则，只访问必要的分区。

- 分区表的应用场景

  - 对业务透明，代码更简洁
  - 清理历史数据方便

    - 删掉分区：alter table t drop partition …会直接删除分区文件，效果跟 drop 普通表类似
    - 与使用 delete 语句删除数据相比，速度快，对系统影响小

- 注意事项

  - 1. 分区并不是越细越好。
  - 2. 分区也不要提前预留太多，在使用之前预先创建即可。比如，如果是按月分区，每年年底时再把下一年度的 12 个新分区创建上即可。对于没有数据的历史分区，要及时的 drop 掉。

- 其他分区方法：[官方手册](https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html)
- 思考题

  - 文章中举例只用到了日期字段，没有自增主键，如果要定义这个表的主键，怎么定义？为什么？

    - MySQL 要求主键包含所有的分区字段

      - 这里必须创建联合主键

    - 从利用率上看，应该创建 (ftime, id)

      - InnoDB 要求至少有一个索引，以自增字段作为第一个字段，所以还要创建一个 id 的单独索引

    - 上面的方案反过来也可以 (id, ftime) (ftime)

- 评论区

  - 分区表的用法跟普通表，在 sql 语句上是相同的。
