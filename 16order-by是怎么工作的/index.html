<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=description content="MySQL 会给每个线程分配一块内存用于排序，称为 sort_buffer
  select city,name,age from t where city=&lsquo;杭州&rsquo; order by name limit 1000 ;
  city varchar 16，name varchar 16，age int 11，city 有索引"><meta property="og:title" content="16｜“order by”是怎么工作的？"><meta property="og:description" content="MySQL 会给每个线程分配一块内存用于排序，称为 sort_buffer
  select city,name,age from t where city=&lsquo;杭州&rsquo; order by name limit 1000 ;
  city varchar 16，name varchar 16，age int 11，city 有索引"><meta property="og:type" content="website"><meta property="og:image" content="https://wangze.tech/icon.png"><meta property="og:url" content="https://wangze.tech/16order-by%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="16｜“order by”是怎么工作的？"><meta name=twitter:description content="MySQL 会给每个线程分配一块内存用于排序，称为 sort_buffer
  select city,name,age from t where city=&lsquo;杭州&rsquo; order by name limit 1000 ;
  city varchar 16，name varchar 16，age int 11，city 有索引"><meta name=twitter:image content="https://wangze.tech/icon.png"><title>16｜“order by”是怎么工作的？</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://wangze.tech//icon.png><link href=https://wangze.tech/styles.80333fa2099c0bee674efa435fde378c.min.css rel=stylesheet><link href=https://wangze.tech/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://wangze.tech/js/darkmode.24b68043ebfc795e1025c251ef25ab3a.min.js></script>
<script src=https://wangze.tech/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://wangze.tech/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://wangze.tech/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://wangze.tech/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://wangze.tech/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://wangze.tech/",fetchData=Promise.all([fetch("https://wangze.tech/indices/linkIndex.eb867949234a67140de00833ad93c6d2.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://wangze.tech/indices/contentIndex.5e3a15f00111011be6cbdbe473df23ca.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://wangze.tech",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://wangze.tech",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/wangze.tech\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=wangze.tech src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=搜索 placeholder=进行搜索......><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://wangze.tech/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://wangze.tech/>🪴 11ze's Garden</a></h1><div class=spacer></div><div id=search-icon><p>搜索</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">搜索图标</title><desc id="desc">打开搜索图标</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>明亮模式</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>黑暗模式</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><script async src="https://www.googletagmanager.com/gtag/js?id=G-SZZLS6FREP"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SZZLS6FREP",{anonymize_ip:!1})}</script><article><h1>16｜“order by”是怎么工作的？</h1><p class=meta>最后更新于
May 17, 2023</p><ul class=tags><li><a href=https://wangze.tech/tags/MySQL/>MySQL</a></li></ul><ul><li><p>MySQL 会给每个线程分配一块内存用于排序，称为 sort_buffer</p></li><li><p>select city,name,age from t where city=&lsquo;杭州&rsquo; order by name limit 1000 ;</p><ul><li><p>city varchar 16，name varchar 16，age int 11，city 有索引</p></li><li><ol><li>初始化 sort_buffer，确定放入 name、city、age 这三个字段；</li></ol></li><li><ol start=2><li>从索引 city 找到第一个满足 city=&lsquo;杭州’条件的主键 id；</li></ol></li><li><ol start=3><li>到主键 id 索引取出整行，取 name、city、age 三个字段的值，存入 sort_buffer 中；</li></ol></li><li><ol start=4><li>从索引 city 取下一个记录的主键 id；</li></ol></li><li><ol start=5><li>重复步骤 3、4 直到 city 的值不满足查询条件为止；</li></ol></li><li><ol start=6><li>对 sort_buffer 中的数据按照字段 name 做快速排序；</li></ol><ul><li>可能在内存中完成，也可能需要使用外部排序，这取决于排序所需的内存和参数 sort_buffer_size。</li></ul></li><li><ol start=7><li>按照排序结果取前 1000 行返回给客户端。</li></ol></li><li><p>全字段排序</p><ul><li><img loading=lazy src=https://cdn.jsdelivr.net/gh/11ze/static/images/mysql45-16-1.png width=auto alt=image.png></li></ul></li></ul></li><li><p>sort_buffer_size，就是 MySQL 为排序开辟的内存（sort_buffer）的大小。如果要排序的数据量小于 sort_buffer_size，排序就在内存中完成。但如果排序数据量太大，内存放不下，则不得不利用磁盘临时文件辅助排序。</p></li><li><p>确定一个排序语句是否使用了临时文件</p><ul><li>/* 打开optimizer_trace，只对本线程有效 <em>/SET optimizer_trace=&lsquo;enabled=on&rsquo;; /</em> @a保存Innodb_rows_read的初始值 <em>/select VARIABLE_VALUE into @a from performance_schema.session_status where variable_name = &lsquo;Innodb_rows_read&rsquo;;/</em> 执行语句 <em>/select city, name,age from t where city=&lsquo;杭州&rsquo; order by name limit 1000; /</em> 查看 OPTIMIZER_TRACE 输出 <em>/SELECT * FROM <code>information_schema</code>.<code>OPTIMIZER_TRACE</code>\G/</em> @b保存Innodb_rows_read的当前值 <em>/select VARIABLE_VALUE into @b from performance_schema.session_status where variable_name = &lsquo;Innodb_rows_read&rsquo;;/</em> 计算Innodb_rows_read差值，表示整个执行过程扫描了多少行 */select @b-@a;</li></ul></li><li><p>外部排序时，一般使用归并排序算法</p></li><li><p>如果 MySQL 认为排序的单行长度太大会怎么做呢？</p><ul><li><p>max_length_for_sort_data，是 MySQL 中专门控制用于排序的行数据的长度的一个参数。它的意思是，如果单行的长度超过这个值，MySQL 就认为单行太大，要换一个算法。</p><ul><li>如果只算 rowid 还是小于此设置，一样是 rowid 排序，但是会转用磁盘排序</li></ul></li><li><p>设置值为 16，小于前面查询语句排序的三个字段的总和</p></li><li><p>此时因为无法直接返回了，整个执行流程变成下面的样子</p></li><li><ol><li>初始化 sort_buffer，确定放入两个字段，即 name 和 id；</li></ol></li><li><ol start=2><li>从索引 city 找到第一个满足 city=&lsquo;杭州’条件的主键 id；</li></ol></li><li><ol start=3><li>到主键 id 索引取出整行，取 name、id 这两个字段，存入 sort_buffer 中；</li></ol></li><li><ol start=4><li>从索引 city 取下一个记录的主键 id；</li></ol></li><li><ol start=5><li>重复步骤 3、4 直到不满足 city=&lsquo;杭州’条件为止；</li></ol></li><li><ol start=6><li>对 sort_buffer 中的数据按照字段 name 进行排序；</li></ol></li><li><ol start=7><li>遍历排序结果，取前 1000 行，并按照 id 的值回到原表中取出 city、name 和 age 三个字段返回给客户端。</li></ol><ul><li>不需要在服务端再耗费内存存储结果，是直接返回给客户端的</li></ul></li><li><p>rowid 排序</p><ul><li><img loading=lazy src=https://cdn.jsdelivr.net/gh/11ze/static/images/mysql45-16-2.png width=auto alt=image.png></li></ul></li></ul></li><li><p>全字段排序 VS rowid 排序</p><ul><li>MySQL 的一个设计思想：如果内存够，就要多利用内存，尽量减少磁盘访问。</li><li>对于 InnoDB 表来说，rowid 排序会要求回表多造成磁盘读，因此不会被优先选择。</li></ul></li><li><p>如果数据天然有序，则 order by 并不需要上面的排序操作，会执行快很多</p><ul><li>比如将 city 索引改成 city + name 的联合索引</li></ul></li><li><p>如果建立三个字段的联合索引，还能省去回表过程</p><ul><li>Explain 结果的 Extra 字段如果有 Using index 则表示使用了覆盖索引</li><li>回表的操作是随机 IO，会造成大量的随机读，不一定就比全字段排序减少对磁盘的访问</li></ul></li><li><p>思考题</p><ul><li><p>假设你的表里面已经有了 city_name(city, name) 这个联合索引，然后你要查杭州和苏州两个城市中所有的市民的姓名，并且按名字排序，显示前 100 条记录。如果 SQL 查询语句是这么写的 ：</p></li><li><p>mysql> select * from t where city in (&lsquo;杭州&rsquo;,&ldquo;苏州&rdquo;) order by name limit 100;</p></li><li><p>这个语句执行的时候会有排序过程吗，为什么？</p><ul><li>有，单个 city 内部的 name 才是递增的</li></ul></li><li><p>如果业务端代码由你来开发，需要实现一个在数据库端不需要排序的方案，你会怎么实现呢？</p><ul><li>分成两个查询语句分别查一百条，然后在业务代码中合并查询结果</li></ul></li><li><p>进一步地，如果有分页需求，要显示第 101 页，也就是说语句最后要改成 “limit 10000,100”， 你的实现方法又会是什么呢？</p><ul><li><p>select * from t where city=&ldquo;杭州&rdquo; order by name limit 10100; select * from t where city=&ldquo;苏州&rdquo; order by name limit 10100。</p><ul><li>数据量太大时可以把 * 改写成只返回必要的数据</li></ul></li></ul></li></ul></li><li><p>评论区</p><ul><li><p>varchar(n)，n 的值中，255 是个边界，小于等于 255 需要一个字节记录长度，超过就需要两个字节</p></li><li><p>排序相关的内存在排序后就会释放掉，还给系统</p></li><li><p>假设给一行的 a 值加 1，执行器先找引擎取行，此时已经加了写锁</p></li><li><p>引擎内部自己调用，读取行，不加扫描行数</p><ul><li>对于 using index condition 的场景，执行器只调用了一次查询接口，回表是由存储层来完成的，所以扫描行数只算一次，即只算走索引搜索的过程中扫描的行数。</li><li>加索引的时候，要扫描全表，但如果是inplace DDL（@第13篇），你会看到扫描行数是0，也是因为这些扫描动作都是引擎内部自己调用的。</li></ul></li><li><p>Using where 包含了一个“值比较”的过程。</p><ul><li>using index condiction 索引下推using index 索引覆盖using where 代表过滤元组 可以理解为使用了where using where 和 using index一起出现代表使用了索引过滤数据</li></ul></li></ul></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li><a href=/MySQL-%E5%AE%9E%E6%88%98-45-%E8%AE%B2/ data-ctx="16｜“order by”是怎么工作的？" data-src=/MySQL-%E5%AE%9E%E6%88%98-45-%E8%AE%B2 class=internal-link>MySQL 实战 45 讲</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>互动图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://wangze.tech/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><script src=https://giscus.app/client.js data-repo=11ze/knowledge-garden data-repo-id=R_kgDOJhaxtw data-category=General data-category-id=DIC_kwDOJhaxt84CWa3R data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script><div id=contact_buttons><footer><p>由 11ze 用 <a href=https://github.com/jackyzha0/quartz>Quartz</a> 创造, © 2023</p><ul><li><a href=https://wangze.tech/>主页</a></li><li><a href=https://twitter.com/11ze4>Twitter</a></li><li><a href=https://github.com/11ze>GitHub</a></li></ul></footer></div></div></body></html>